#!/bin/bash

#
# Wraps make
#

# Environment
declare -ri NCORES=${NCORES:-2}

# Options
set -o errexit -o noglob -o nounset -o pipefail
shopt -s expand_aliases

# Script name
declare -r SELF=${0##*/}

# Exported to use in makefiles and Sakefile
declare -xr JQTLIB='/usr/local/share/jqt'

# GMake call
declare -ra makeflags=(
    --jobs=$(( NCORES * 150 / 100  ))  # NCORES * 1.5
    --makefile=Sakefile
    --output-sync=target
)
alias _sake='exec make "${makeflags[@]}"'

# Check project on current directory
if test ! -e Sakefile; then
    echo 1>&2 "${SELF}: no \`Sakefile\` found."
    exit 1
fi
if test ! -e config.yaml && test ! -e config.json; then
    echo 1>&2 "${SELF}: no \`config.yaml\` or \`config.json\` file found."
    exit 1
fi

# Check arguments
[[ $# == 0 ]] && set -- build

# Run _sake
case $1 in
    dag)
        make -f Sakefile -Bdn \
            | sed -n \
                -e "s/'//g" \
                -e 's/\.$//' \
                -e 's/Considering target file //p'
        ;;
    help)
        echo 1>&2 "${SELF}: Target \`help\` not implemented."
        exit 1
        ;;
    new)
        echo 1>&2 "${SELF}: Target \`new\` not implemented."
        exit 1
        ;;
    list)
        echo 'Usage: sake [goal] [[options] [variable=string] ...]'
        echo 'Goals:'
        make -f Sakefile -dpq 2>&1 \
            | grep -v '^[SmM]akefile' \
            | awk '/^[^ \t.%][-A-Za-z0-9_.]*:/ { print $1 }' \
            | sort --unique \
            | sed 's/:\+$//' \
            | pr --omit-pagination --width=80 --columns=6
        ;;
    touch)
        if test -e config.yaml; then touch config.yaml; else touch config.json; fi
        shift
        _sake build "$@"
        ;;
    config)
        shift
        _sake configure "$@"
        ;;
    clober)
        shift
        _sake clobber "$@"
        ;;
    *)
        _sake "$@"
        ;;
esac

# vim:ai:sw=4:ts=4:et:syntax=sh
